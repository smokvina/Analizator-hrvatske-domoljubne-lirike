<main class="min-h-screen container mx-auto px-4 py-8 md:py-16 flex flex-col items-center">
  <div class="w-full max-w-4xl">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight">
        Analizator hrvatske domoljubne lirike
      </h1>
      <p class="mt-3 text-lg text-slate-400">
        AI analiza poezije Marka Perkovića Thompsona
      </p>
    </header>

    @if (errorMessage()) {
      <div class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg relative mb-6" role="alert">
        <strong class="font-bold">Greška!</strong>
        <span class="block sm:inline ml-2">{{ errorMessage() }}</span>
      </div>
    }

    <div class="bg-slate-800/50 p-6 md:p-8 rounded-2xl shadow-2xl border border-slate-700 backdrop-blur-sm">
      @switch (appState()) {
        @case ('initial') {
          <div class="flex flex-col">
            <h2 class="text-2xl font-semibold text-white mb-2">Dobrodošli</h2>
            <p class="text-slate-400 mb-6">Unesite ime pjesme ili stih Marka Perkovića Thompsona za analizu.</p>
            <textarea #userInputArea
              class="w-full h-32 p-4 bg-slate-900 border border-slate-600 rounded-lg text-lg text-slate-200 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors duration-200 resize-none"
              placeholder="Npr. 'Bojna Čavoglave' ili 'Domu mom'... "
              (input)="userInput.set(userInputArea.value)">{{ userInput() }}</textarea>
            <button
              (click)="handleInitialAnalysis()"
              [disabled]="isLoading() || userInput().trim().length === 0"
              class="mt-6 w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-lg font-semibold rounded-lg text-white bg-sky-600 hover:bg-sky-700 disabled:bg-slate-500 disabled:cursor-not-allowed transition-colors duration-200 shadow-lg">
              @if (isLoading()) {
                <app-loading-spinner />
                <span>Pretražujem...</span>
              } @else {
                <span>Identificiraj Pjesmu</span>
              }
            </button>
            @if(history().length > 0) {
              <button (click)="showHistory()"
                class="mt-4 w-full inline-flex items-center justify-center px-6 py-3 border border-slate-600 text-lg font-semibold rounded-lg text-white bg-slate-700 hover:bg-slate-600 transition-colors duration-200">
                Prikaži Povijest Analiza ({{ history().length }})
              </button>
            }
          </div>
        }
        @case ('song_identified') {
          @if(songInfo(); as song) {
            <div>
              <h2 class="text-2xl font-semibold text-white">Pjesma Identificirana</h2>
              <div class="mt-4 p-4 bg-slate-900/70 rounded-lg border border-slate-700">
                <p class="text-xl font-bold text-sky-400">{{ song.title }}</p>
                <p class="text-slate-300">Album: {{ song.album }} ({{ song.year }})</p>
              </div>

              <div class="mt-6">
                <h3 class="text-lg font-semibold text-white mb-2">Stihovi</h3>
                <div class="max-h-60 overflow-y-auto bg-slate-900/70 p-4 rounded-lg border border-slate-700 whitespace-pre-wrap text-slate-300">
                  {{ song.lyrics }}
                </div>
              </div>

              <p class="mt-8 text-slate-300">Odaberite vrstu analize:</p>
              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button (click)="performAnalysis('theological')" class="px-6 py-3 border border-slate-600 text-lg font-semibold rounded-lg text-white bg-slate-700 hover:bg-slate-600 transition-colors duration-200">
                  (A) Teološka analiza
                </button>
                <button (click)="performAnalysis('political')" class="px-6 py-3 border border-slate-600 text-lg font-semibold rounded-lg text-white bg-slate-700 hover:bg-slate-600 transition-colors duration-200">
                  (B) Politička analiza
                </button>
              </div>
            </div>
          }
        }
        @case ('analyzing') {
          <div class="text-center py-12">
            <app-loading-spinner [large]="true"/>
            <p class="text-xl mt-4 text-slate-300 animate-pulse">{{ analysisStatus() }}</p>
          </div>
        }
        @case ('analysis_complete') {
          <div>
            <h2 class="text-3xl font-bold text-white capitalize border-b-2 border-sky-500 pb-2 mb-6">{{ analysisType() }} Analiza</h2>
            <div class="prose prose-invert prose-lg max-w-none text-slate-300 whitespace-pre-wrap leading-relaxed">
              {{ analysisResult() }}
            </div>

            @if(isLoadingImage()) {
              <div class="text-center py-8 mt-8 border-t border-slate-700">
                <app-loading-spinner />
                <p class="text-md mt-2 text-slate-400">Generiram umjetničku vizualizaciju...</p>
              </div>
            } @else if(generatedImage()) {
              <div class="mt-10 pt-8 border-t border-slate-700">
                 <h3 class="text-2xl font-bold text-white mb-4">Umjetnička Vizualizacija</h3>
                 <div class="bg-black rounded-lg overflow-hidden shadow-lg">
                    <img [src]="generatedImage()" alt="Umjetnička vizualizacija pjesme" class="w-full h-auto object-cover" />
                 </div>
              </div>
            }

            <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-4">
               @if(!isCurrentAnalysisSaved()) {
                <button (click)="saveAnalysis()" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-lg font-semibold rounded-lg text-white bg-teal-600 hover:bg-teal-700 transition-colors duration-200">
                  Spremi Analizu
                </button>
              } @else {
                 <div class="w-full flex items-center justify-center px-6 py-3 border border-slate-700 text-lg font-semibold rounded-lg text-slate-400 bg-slate-800/50">
                  Analiza Spremljena
                </div>
              }
              <button (click)="reset()" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-lg font-semibold rounded-lg text-white bg-sky-600 hover:bg-sky-700 transition-colors duration-200">
                Započni Novu Analizu
              </button>
            </div>

          </div>
        }
        @case ('history') {
          <div>
            <div class="flex justify-between items-center border-b-2 border-sky-500 pb-2 mb-6">
              <h2 class="text-3xl font-bold text-white">Povijest Analiza</h2>
              <button (click)="appState.set('initial')" class="px-4 py-2 border border-slate-600 text-md font-semibold rounded-lg text-white bg-slate-700 hover:bg-slate-600 transition-colors duration-200">
                Natrag
              </button>
            </div>

            @if(history().length === 0) {
              <p class="text-slate-400 text-center py-10">Nemate spremljenih analiza.</p>
            } @else {
              <div class="flex justify-end mb-4">
                <button (click)="clearHistory()" class="text-sm text-red-400 hover:text-red-300 font-semibold">
                  Očisti Povijest
                </button>
              </div>
              <div class="space-y-6">
                @for(item of history(); track item.timestamp) {
                  <div class="bg-slate-900/70 p-6 rounded-lg border border-slate-700">
                    <div class="border-b border-slate-600 pb-3 mb-4">
                      <h3 class="text-xl font-bold text-sky-400">{{ item.songInfo.title }}</h3>
                      <p class="text-sm text-slate-400">{{ item.songInfo.album }} ({{ item.songInfo.year }})</p>
                       <p class="text-sm text-slate-300 font-semibold capitalize mt-1">{{ item.analysisType === 'theological' ? 'Teološka' : 'Politička' }} analiza</p>
                    </div>
                    
                    <div class="mb-4">
                      <h4 class="text-md font-semibold text-slate-200 mb-2">Stihovi</h4>
                      <div class="max-h-48 overflow-y-auto bg-slate-800 p-3 rounded-md text-sm whitespace-pre-wrap text-slate-300">
                          {{ item.songInfo.lyrics }}
                      </div>
                    </div>

                    <h4 class="text-md font-semibold text-slate-200 mb-2">Analiza</h4>
                    <div class="prose prose-invert prose-md max-w-none text-slate-300 whitespace-pre-wrap leading-relaxed">
                      {{ item.analysisResult }}
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      }
    </div>
    <footer class="text-center mt-10 text-slate-500 text-sm">
      <p>Pokreće Google Gemini API. Analize su generirane od strane umjetne inteligencije i služe u informativne svrhe.</p>
    </footer>
  </div>
</main>